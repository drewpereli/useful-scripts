#!/usr/bin/env node
const path = require("path");
const pr = path.resolve;
const fs = require("fs").promises;

let svgPath = process.argv[2];

if (!svgPath) {
  throw new Error("Please specify a path to your svg as the first argument");
}

let namespace = path.basename(svgPath).split(".")[0];

let svgPathAbs = pr(process.cwd(), svgPath);

(async () => {
  let svg = String(await fs.readFile(svgPathAbs));

  let idRegexp = /id="(?<id>.+?)"/g;

  let ids = [];
  let idMatch;

  while ((idMatch = idRegexp.exec(svg))) {
    ids.push(idMatch.groups.id);
  }

  let idDefReplaceRegexp = new RegExp(`id="(${ids.join("|")})"`, "g");
  let idUseReplaceRegexp = new RegExp(`#(${ids.join("|")})`, "g");

  let newSvg = svg
    .replace(idDefReplaceRegexp, `id="${namespace}_$1"`)
    .replace(idUseReplaceRegexp, `#${namespace}_$1`);

  await fs.writeFile(svgPathAbs, newSvg);
})();
