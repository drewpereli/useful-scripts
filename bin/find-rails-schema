#!/usr/bin/env node

const { exec } = require('child_process');

const fs = require('fs').promises;

async function findSchema(input) {
  const name = toSnakeCase(input);

  const regex = new RegExp(`create_table "${name}s?"`);

  const schema = String(await fs.readFile('./db/schema.rb'));

  const lines = schema.split('\n');

  const lineNum = lines.findIndex((line) => regex.test(line));

  if (lineNum === -1) {
    console.error(`Could not find schema "${name}"`);
    return;
  }

  exec(`code -g ./db/schema.rb:${lineNum + 1}`);
}

const toSnakeCase = (str) =>
  str &&
  str
    .match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g)
    .map((x) => x.toLowerCase())
    .join('_');

findSchema(process.argv[2]);
